import React, { useState, useEffect } from 'react';

// --- API helpers ---
const API_BASE = (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.VITE_API_BASE) || '';

const apiFetch = async (path, options = {}) => {
  const res = await fetch(`${API_BASE}${path}`, options);
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || `Request failed: ${res.status}`);
  }
  return res.json();
};

const loginApi = (email, password) =>
  apiFetch('/api/v1/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password }),
  });

const fetchPatientsApi = (token) =>
  apiFetch('/api/v1/patients', {
    headers: { Authorization: `Bearer ${token}` },
  });

const fetchAssessmentsApi = (token, patientId) =>
  apiFetch(`/api/v1/patients/${patientId}/assessments`, {
    headers: { Authorization: `Bearer ${token}` },
  });

const createPatientApi = (token, payload) =>
  apiFetch('/api/v1/patients', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });

const createAssessmentApi = (token, patientId, payload) =>
  apiFetch(`/api/v1/patients/${patientId}/assessments`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`,
    },
    body: JSON.stringify(payload),
  });
import { 
  Activity, 
  Users, 
  LogOut, 
  Search, 
  Plus, 
  ChevronRight, 
  Droplet, 
  TrendingUp, 
  AlertCircle,
  Thermometer,
  LayoutDashboard,
  Download,
  Database,
  ArrowRight,
  Filter,
  ArrowLeft,
  Clipboard,
  Heart,
  Cigarette,
  PieChart,
  Info,
  Stethoscope,
  Save,
  Maximize2,
  CheckCircle,
  XCircle,
  FileText,
  BarChart2
} from 'lucide-react';

/* --- THEME CONFIGURATION --- */
const THEME = {
  colors: {
    bg: '#F4F7FE',
    surface: '#FFFFFF',
    sidebar: '#0B1437',
    sidebarGradient: 'linear-gradient(180deg, #0B1437 0%, #111C44 100%)',
    primary: '#4318FF',
    primaryLight: '#6AD2FF',
    primaryDark: '#2B3674',
    secondary: '#707EAE',
    secondaryLight: '#A3AED0',
    textMain: '#1B2559',
    textSec: '#A3AED0',
    divider: '#E0E5F2',
    inputBg: '#F4F7FE',
    status: {
      high_risk_bg: "#111C44",
      high_risk_text: "#FFFFFF",
      low_risk_bg: "#6AD2FF",
      low_risk_text: "#1B2559",
      success: "#05CD99",
      warning: "#FFB547",
      error: "#EE5D50"
    }
  },
  fonts: {
    main: '"DM Sans", sans-serif',
  }
};

/* --- MOCK DATA --- */
const MOCK_PATIENTS = [
  { 
    id: 1, 
    name: "Elena Rostova", 
    age: 48, 
    status: "Perimenopause", 
    yearsMenopause: 0,
    bmi: 34.5,
    fbs: 126, 
    hba1c: 7.1, 
    risk: 82, 
    cluster: "SOIRD", 
    lastVisit: "2024-10-12", 
    idNumber: "P-2024-001",
    bp: "135/85",
    activity: "Sedentary",
    smoking: "No",
    hypertension: "Yes",
    heartDisease: "No",
    lipids: { chol: 210, ldl: 130, hdl: 45, tg: 160 },
    history: [
      { date: '2023-01', hba1c: 5.8, fbs: 102 },
      { date: '2024-10', hba1c: 7.1, fbs: 126 },
    ]
  },
  { 
    id: 2, 
    name: "Maria Santos", 
    age: 58, 
    status: "Postmenopause", 
    yearsMenopause: 7,
    bmi: 24.2,
    fbs: 98, 
    hba1c: 5.4, 
    risk: 45, 
    cluster: "MARD", 
    lastVisit: "2024-10-15", 
    idNumber: "P-2024-002",
    bp: "120/80",
    activity: "Active",
    smoking: "No",
    hypertension: "No",
    heartDisease: "No",
    lipids: { chol: 180, ldl: 100, hdl: 60, tg: 110 },
    history: [
      { date: '2024-10', hba1c: 5.4, fbs: 98 },
    ]
  },
  { 
    id: 3, 
    name: "Sarah Jenkins", 
    age: 46, 
    status: "Perimenopause", 
    yearsMenopause: 0,
    bmi: 23.0,
    fbs: 145, 
    hba1c: 8.2, 
    risk: 91, 
    cluster: "SIDD", 
    lastVisit: "2024-10-18", 
    idNumber: "P-2024-003",
    bp: "110/70",
    activity: "Moderate",
    smoking: "Yes",
    hypertension: "No",
    heartDisease: "No",
    lipids: { chol: 190, ldl: 110, hdl: 55, tg: 140 },
    history: [
      { date: '2024-10', hba1c: 8.2, fbs: 145 },
    ]
  },
  { id: 4, name: "Li Wei", age: 55, status: "Postmenopause", fbs: 102, hba1c: 5.9, risk: 25, cluster: "MIDD", lastVisit: "2024-10-20", idNumber: "P-2024-004", bp: "125/82", bmi: 22.5, activity: "Moderate", smoking: "No", hypertension: "Yes", history: [] },
  { id: 5, name: "Carmela Diaz", age: 50, status: "Menopause", fbs: 115, hba1c: 6.3, risk: 55, cluster: "MARD", lastVisit: "2024-10-22", idNumber: "P-2024-005", bp: "130/85", bmi: 26.0, activity: "Moderate", smoking: "No", hypertension: "No", history: [] },
  { id: 6, name: "Ana Reyes", age: 49, status: "Perimenopause", fbs: 130, hba1c: 7.5, risk: 88, cluster: "SOIRD", lastVisit: "2024-10-25", idNumber: "P-2024-006", bp: "140/90", bmi: 36.2, activity: "Sedentary", smoking: "No", hypertension: "Yes", history: [] },
  { id: 7, name: "Jasmine Lee", age: 60, status: "Postmenopause", fbs: 105, hba1c: 6.0, risk: 35, cluster: "MARD", lastVisit: "2024-10-26", idNumber: "P-2024-007", bp: "128/84", bmi: 25.5, activity: "Active", smoking: "No", hypertension: "No", history: [] },
];

/* --- COMPONENTS --- */

const Button = ({ children, variant = 'primary', className = '', onClick, icon: Icon, fullWidth }) => {
  const baseStyle = "relative overflow-hidden group px-6 py-3 transition-all duration-300 ease-out flex items-center justify-center gap-2 rounded-xl font-medium tracking-wide shadow-sm hover:shadow-md active:scale-95";
  const variants = {
    primary: `bg-[${THEME.colors.primary}] text-white hover:bg-[${THEME.colors.primaryDark}]`,
    outline: `border-2 border-[${THEME.colors.primary}] text-[${THEME.colors.primary}] hover:bg-[${THEME.colors.primary}] hover:text-white`,
    ghost: `text-[${THEME.colors.textSec}] hover:text-[${THEME.colors.primary}] hover:bg-[#F4F7FE]`,
    danger: `bg-[${THEME.colors.status.error}] text-white hover:opacity-90`
  };

  return (
    <button 
      onClick={onClick}
      className={`${baseStyle} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`}
      style={{ fontFamily: THEME.fonts.main }}
    >
      {Icon && <Icon size={18} className="relative z-10" />}
      <span className="relative z-10">{children}</span>
    </button>
  );
};

const Login = ({ onLogin }) => {
  const [mounted, setMounted] = useState(false);
  const [email, setEmail] = useState('clinician@example.com');
  const [password, setPassword] = useState('password123');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  useEffect(() => setMounted(true), []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      await onLogin(email, password);
    } catch (err) {
      setError('Invalid credentials or server unavailable.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen w-full flex relative overflow-hidden bg-[#F4F7FE]">
      <div className={`hidden lg:flex flex-col justify-between w-5/12 p-12 relative z-10 transition-all duration-1000 transform ${mounted ? 'translate-x-0 opacity-100' : '-translate-x-10 opacity-0'}`}
           style={{ background: THEME.colors.sidebarGradient }}>
        <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full bg-[#4318FF] opacity-20 blur-3xl"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full bg-[#6AD2FF] opacity-10 blur-3xl"></div>
        <div>
          <div className="flex items-center gap-3 mb-8">
            <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-[#0B1437] font-bold text-xl shadow-lg">D</div>
            <span className="text-3xl text-white font-bold tracking-tight">DIANA</span>
          </div>
          <h1 className="text-5xl font-bold leading-tight text-white mb-6">
            Predictive Model-Based Application
          </h1>
          <p className="text-[#A3AED0] text-lg max-w-md leading-relaxed">
            Using selected blood biomarkers for identifying menopausal women at risk of Type 2 Diabetes.
          </p>
        </div>
        
        <div className="glass-panel p-6 rounded-2xl bg-white/10 backdrop-blur-md border border-white/10">
          <div className="flex items-center gap-4 mb-2">
            <div className="w-2 h-2 rounded-full bg-[#05CD99]"></div>
            <span className="text-white font-bold text-sm uppercase tracking-wider">System Status</span>
          </div>
          <p className="text-white/80 text-sm">Predictive Engine Online • Database Connected</p>
        </div>
      </div>
      <div className="w-full lg:w-7/12 flex items-center justify-center p-8 relative z-10">
        <div className={`w-full max-w-md p-8 transition-all duration-1000 delay-300 transform ${mounted ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0'}`}>
          <div className="mb-10">
            <h2 className="text-4xl font-bold text-[#1B2559] mb-3">Sign In</h2>
            <p className="text-[#A3AED0]">Enter your medical credentials to access patient data.</p>
          </div>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="space-y-2">
              <label className="text-[#1B2559] text-sm font-bold ml-1">Email</label>
              <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-white border border-[#E0E5F2] text-[#1B2559] p-4 rounded-2xl focus:outline-none focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 transition-all shadow-sm" />
            </div>
            <div className="space-y-2">
              <label className="text-[#1B2559] text-sm font-bold ml-1">Password</label>
              <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-white border border-[#E0E5F2] text-[#1B2559] p-4 rounded-2xl focus:outline-none focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 transition-all shadow-sm" />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <Button fullWidth onClick={handleSubmit} className={loading ? 'opacity-70' : ''}>{loading ? 'Signing In...' : 'Sign In'}</Button>
          </form>
        </div>
      </div>
    </div>
  );
};

const Sidebar = ({ activeTab, setActiveTab, onStartAssessment }) => {
  const navItems = [
    { id: 'dashboard', icon: LayoutDashboard, label: 'Dashboard' },
    { id: 'patients', icon: Users, label: 'Patient History' }, 
    { id: 'analytics', icon: Activity, label: 'Analytics' },
    { id: 'export', icon: Download, label: 'Export Data' }, 
  ];

  return (
    <div className="w-20 lg:w-72 h-screen fixed left-0 top-0 flex flex-col z-50 transition-all duration-300 shadow-2xl" style={{ background: THEME.colors.sidebarGradient }}>
      <div className="p-8 flex items-center justify-center lg:justify-start gap-3 border-b border-white/10">
        <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center shrink-0 shadow-lg">
          <span className="text-[#0B1437] font-bold">D</span>
        </div>
        <span className="text-2xl text-white font-bold hidden lg:block tracking-wide">DIANA</span>
      </div>

      <div className="p-6">
        <Button 
          fullWidth 
          onClick={onStartAssessment}
          className="bg-white text-[#4318FF] hover:bg-[#F4F7FE] shadow-lg border-none py-4 transform hover:scale-105 transition-transform"
          icon={Plus}
        >
          <span className="hidden lg:inline">New Assessment</span>
        </Button>
      </div>

      <nav className="flex-1 px-4 space-y-2">
        {navItems.map((item) => {
          const isActive = activeTab === item.id;
          const Icon = item.icon;
          return (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className={`w-full flex items-center gap-4 p-4 rounded-xl transition-all duration-200 group relative
                ${isActive ? 'bg-white/10 text-white shadow-lg backdrop-blur-sm' : 'text-[#A3AED0] hover:text-white hover:bg-white/5'}`}
            >
              <Icon size={20} className={isActive ? "text-white" : "text-[#A3AED0] group-hover:text-white"} />
              <span className="hidden lg:block font-medium">{item.label}</span>
              {isActive && <div className="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-[#4318FF] rounded-l-full hidden lg:block" />}
            </button>
          );
        })}
      </nav>
      <div className="p-8">
        <button className="w-full flex items-center gap-4 mt-8 text-[#A3AED0] hover:text-white transition-colors lg:pl-4">
          <LogOut size={20} />
          <span className="hidden lg:block font-medium">Log Out</span>
        </button>
      </div>
    </div>
  );
};

const Dashboard = ({ onNavigateToPatient, onStartAssessment }) => {
  const [activeBiomarker, setActiveBiomarker] = useState('hba1c');

  return (
    <div className="space-y-8 animate-fade-in pb-8">
      <header className="flex flex-col md:flex-row justify-between items-start md:items-end pb-2">
        <div>
          <h4 className="text-[#707EAE] font-medium text-sm mb-1">Overview</h4>
          <h2 className="text-3xl font-bold text-[#1B2559]">Dashboard</h2>
        </div>
        <div className="mt-4 md:mt-0 bg-white p-2 rounded-full shadow-sm flex items-center gap-2 pr-4 cursor-pointer hover:shadow-md transition-shadow border border-[#E0E5F2]">
          <div className="w-8 h-8 rounded-full bg-[#F4F7FE] flex items-center justify-center text-[#1B2559] font-bold">MA</div>
          <span className="text-[#1B2559] font-medium text-sm">Dr. M. Angeles</span>
        </div>
      </header>

      {/* Quick Actions & Stats Row */}
      <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
        {/* Quick Start Card */}
        <div 
          onClick={onStartAssessment}
          className="lg:col-span-1 bg-gradient-to-br from-[#4318FF] to-[#6AD2FF] p-6 rounded-3xl shadow-lg cursor-pointer hover:scale-105 transition-transform flex flex-col justify-center items-center text-white text-center group"
        >
           <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mb-3 group-hover:bg-white/30 transition-colors">
             <Plus size={24} />
           </div>
           <h3 className="font-bold text-lg">New Patient Assessment</h3>
           <p className="text-xs opacity-80 mt-2">Start a cluster-based analysis</p>
        </div>

        {/* Stats */}
        {[
          { label: 'Total Patients', value: '1,248', icon: Users, trend: '+12%', iconColor: '#4318FF', bg: '#F4F7FE' },
          { label: 'High Risk (SOIRD/SIDD)', value: '86', icon: AlertCircle, trend: '+4%', iconColor: '#EE5D50', bg: '#FFF5F5' },
          { label: 'Avg HbA1c', value: '5.8%', icon: Droplet, trend: '-0.2%', iconColor: '#FFB547', bg: '#FFF9EB' },
          { label: 'Avg FBS', value: '102', icon: Activity, trend: '+2.4%', iconColor: '#05CD99', bg: '#E6FBF5' },
        ].map((stat, idx) => (
          <div key={idx} className="lg:col-span-1 bg-white p-6 rounded-3xl shadow-sm hover:shadow-md transition-all duration-300 flex flex-col justify-between border border-[#E0E5F2]">
            <div className="flex justify-between items-start">
               <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg" style={{ backgroundColor: stat.bg, color: stat.iconColor }}>
                 <stat.icon size={20} />
               </div>
               <span className="text-xs font-bold text-[#05CD99] bg-[#E6FBF5] px-2 py-1 rounded-md">{stat.trend}</span>
            </div>
            <div className="mt-4">
              <h3 className="text-2xl font-bold text-[#1B2559]">{stat.value}</h3>
              <p className="text-[#A3AED0] text-xs font-medium uppercase tracking-wider mt-1">{stat.label}</p>
            </div>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-[#E0E5F2]">
          <div className="flex justify-between items-center mb-8">
            <h3 className="text-xl font-bold text-[#1B2559]">Biomarker Trends (Cohort)</h3>
            <div className="flex gap-2 bg-[#F4F7FE] p-1 rounded-lg">
              {['hba1c', 'fbs', 'estradiol'].map((marker) => (
                <button 
                  key={marker}
                  onClick={() => setActiveBiomarker(marker)}
                  className={`px-3 py-1 text-sm font-bold rounded-md transition-all uppercase ${
                    activeBiomarker === marker 
                    ? 'bg-white text-[#1B2559] shadow-sm' 
                    : 'text-[#A3AED0] hover:text-[#1B2559]'
                  }`}
                >
                  {marker}
                </button>
              ))}
            </div>
          </div>
          
          <div className="h-64 w-full relative">
            <div className="absolute inset-0 flex items-end justify-between px-2">
               {[40, 65, 55, 80, 45, 90, 70, 85, 60, 75, 50, 65].map((h, i) => (
                 <div key={i} className="w-full mx-1 group relative">
                   <div 
                    className="w-full bg-[#4318FF] rounded-t-lg transition-all duration-500 hover:opacity-80"
                    style={{ 
                      height: `${h}%`,
                      backgroundColor: activeBiomarker === 'hba1c' ? '#4318FF' : activeBiomarker === 'fbs' ? '#6AD2FF' : '#FFB547'
                    }}
                   ></div>
                   <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-[#1B2559] text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                     {h/10}%
                   </div>
                 </div>
               ))}
            </div>
            <div className="absolute inset-0 flex flex-col justify-between pointer-events-none">
              {[1, 2, 3, 4, 5].map(i => (
                <div key={i} className="w-full h-px bg-[#E0E5F2] border-t border-dashed border-[#E0E5F2]"></div>
              ))}
            </div>
          </div>
          <div className="flex justify-between mt-4 text-[#A3AED0] text-xs font-medium uppercase tracking-wider">
            <span>Jan</span><span>Dec</span>
          </div>
        </div>

        <div className="bg-white p-6 rounded-3xl shadow-sm flex flex-col border border-[#E0E5F2]">
          <h3 className="text-xl font-bold text-[#1B2559] mb-6">Cluster Distribution</h3>
          {/* Cluster Pie Chart Simulation */}
          <div className="flex-1 flex flex-col items-center justify-center relative">
             <div className="w-48 h-48 rounded-full border-[16px] border-[#F4F7FE] flex items-center justify-center relative overflow-hidden"
                  style={{
                    background: 'conic-gradient(#EE5D50 0% 15%, #FFB547 15% 45%, #6AD2FF 45% 75%, #4318FF 75% 100%)'
                  }}>
                <div className="w-24 h-24 bg-white rounded-full flex flex-col items-center justify-center z-10 shadow-inner">
                   <span className="text-2xl font-bold text-[#1B2559]">4</span>
                   <span className="text-[10px] uppercase text-[#A3AED0]">Clusters</span>
                </div>
             </div>
          </div>
          <div className="grid grid-cols-2 gap-4 mt-6">
             <div className="flex items-center gap-2 text-xs text-[#1B2559] font-bold"><div className="w-2 h-2 rounded-full bg-[#EE5D50]"></div> SOIRD (High)</div>
             <div className="flex items-center gap-2 text-xs text-[#1B2559] font-bold"><div className="w-2 h-2 rounded-full bg-[#FFB547]"></div> SIDD (Severe)</div>
             <div className="flex items-center gap-2 text-xs text-[#1B2559] font-bold"><div className="w-2 h-2 rounded-full bg-[#6AD2FF]"></div> MARD (Mild Age)</div>
             <div className="flex items-center gap-2 text-xs text-[#1B2559] font-bold"><div className="w-2 h-2 rounded-full bg-[#4318FF]"></div> MIDD (Mild)</div>
          </div>
          <Button variant="ghost" fullWidth className="mt-4" icon={ArrowRight} onClick={onNavigateToPatient}>View Patients</Button>
        </div>
      </div>
    </div>
  );
};

// Patient History Tab
const PatientHistory = ({ viewState, setViewState, patients: patientsProp = [], loadAssessments, onSubmitAssessment }) => {
  const [selectedPatient, setSelectedPatient] = useState(null);
  
  const [formData, setFormData] = useState({
    name: '', age: '', height: '', weight: '', fbs: '', hba1c: '', menopauseStatus: 'Perimenopause', yearsMenopause: 0, 
    history: false, systolic: '', diastolic: '', activity: 'Sedentary',
    cholesterol: '', ldl: '', hdl: '', triglycerides: '',
    smoking: 'No', hypertension: 'No', heartDisease: 'No'
  });
  
  const [prediction, setPrediction] = useState(null);
  const [cluster, setCluster] = useState(null);
  const [calculatedBMI, setCalculatedBMI] = useState(null);
  const [isComputing, setIsComputing] = useState(false);

  useEffect(() => {
    if (formData.weight && formData.height) {
      const heightM = formData.height / 100;
      const bmi = (formData.weight / (heightM * heightM)).toFixed(1);
      setCalculatedBMI(bmi);
    } else {
      setCalculatedBMI(null);
    }
  }, [formData.weight, formData.height]);

  const calculateRisk = async () => {
    setIsComputing(true);
    setPrediction(null);
    setCluster(null);
    
    try {
      if (onSubmitAssessment) {
        const bmi = parseFloat(calculatedBMI) || 0;
        const result = await onSubmitAssessment(formData, bmi);
        setCluster(result?.cluster || 'N/A');
        setPrediction(result?.risk_score ?? result?.riskScore ?? null);
      } else {
        // fallback mock
        const bmi = parseFloat(calculatedBMI) || 20;
        const hba1c = parseFloat(formData.hba1c) || 5.0;
        let calculatedCluster = "MIDD";
        let riskScore = 20;
        if (bmi > 30 && hba1c > 6.0) {
          calculatedCluster = "SOIRD";
          riskScore = 85;
        } else if (hba1c > 6.5 && bmi < 27) {
          calculatedCluster = "SIDD";
          riskScore = 92;
        } else {
          calculatedCluster = "MIDD";
          riskScore = 30;
        }
        setCluster(calculatedCluster);
        setPrediction(riskScore);
      }
    } catch (err) {
      // simple surface of error
      setCluster('Error');
      setPrediction(null);
    } finally {
      setIsComputing(false);
    }
  };

  const handleViewProfile = async (patient) => {
    setSelectedPatient(patient);
    setViewState('profile');
    if (loadAssessments) {
      try {
        const history = await loadAssessments(patient.id);
        setSelectedPatient({ ...patient, history: history || [] });
      } catch (err) {
        // silently ignore for now; keep mock if present
      }
    }
  };

  const PatientProfileView = ({ patient }) => {
    if (!patient) return null;
    return (
      <div className="animate-fade-in pb-8">
        <div className="flex items-center gap-4 mb-8">
          <button onClick={() => setViewState('list')} className="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-[#1B2559] hover:bg-[#F4F7FE] transition-colors">
            <ArrowLeft size={20} />
          </button>
          <div>
            <h2 className="text-3xl font-bold text-[#1B2559]">{patient.name}</h2>
            <p className="text-[#A3AED0]">ID: {patient.idNumber} • {patient.status}</p>
          </div>
        </div>
        
        <div className={`mb-8 p-8 rounded-3xl flex items-center justify-between text-white shadow-lg relative overflow-hidden ${
          patient.cluster === 'SOIRD' || patient.cluster === 'SIDD' ? 'bg-[#111C44]' : 'bg-[#4318FF]'
        }`}>
           <div className="relative z-10">
             <div className="flex items-center gap-2 opacity-80 text-sm uppercase tracking-widest font-bold mb-2">
                <Activity size={16} /> Clinical Cluster Assignment
             </div>
             <h2 className="text-4xl font-bold">{patient.cluster}</h2>
             <p className="text-lg mt-2 opacity-90 max-w-xl">
               {patient.cluster === 'SOIRD' && 'Severe Obesity-Related & Insulin-Resistant Diabetes'}
               {patient.cluster === 'SIDD' && 'Severe Insulin-Deficient Diabetes'}
               {patient.cluster === 'MARD' && 'Mild Age-Associated Diabetes'}
               {patient.cluster === 'MIDD' && 'Mild Insulin-Deficient Diabetes'}
             </p>
           </div>
           <PieChart size={96} className="opacity-20 absolute right-8 -bottom-4" />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="space-y-8">
            <div className="bg-white p-8 rounded-3xl shadow-sm text-center relative overflow-hidden border border-[#E0E5F2]">
               <div className={`w-32 h-32 mx-auto rounded-full flex items-center justify-center text-4xl font-bold mb-4 relative z-10 transition-all duration-500 ${patient.risk > 66 ? 'bg-[#EE5D50] text-white shadow-red-200 shadow-xl' : patient.risk > 33 ? 'bg-[#FFB547] text-[#1B2559] shadow-orange-200 shadow-xl' : 'bg-[#6AD2FF] text-[#1B2559] shadow-blue-200 shadow-xl'}`}>
                 {patient.risk}%
               </div>
               <h3 className="text-[#1B2559] font-bold text-xl mb-1">Probabilistic Risk</h3>
               <p className="text-[#A3AED0] text-sm">Last assessment: {patient.lastVisit}</p>
            </div>
            
            {/* Validation Component */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-[#E0E5F2]">
               <h4 className="text-[#1B2559] font-bold mb-4 flex items-center gap-2">
                 <FileText size={18} className="text-[#4318FF]" /> Doctor's Validation
               </h4>
               <p className="text-xs text-[#A3AED0] mb-4">Support Phase 5 research data collection.</p>
               <div className="flex gap-2">
                  <Button variant="outline" className="flex-1 border-[#05CD99] text-[#05CD99] hover:bg-[#05CD99] hover:text-white" icon={CheckCircle}>
                    Agree
                  </Button>
                  <Button variant="outline" className="flex-1 border-[#EE5D50] text-[#EE5D50] hover:bg-[#EE5D50] hover:text-white" icon={XCircle}>
                    Disagree
                  </Button>
               </div>
            </div>

            <div className="bg-white p-6 rounded-3xl shadow-sm border border-[#E0E5F2]">
              <h4 className="text-[#1B2559] font-bold mb-4 flex items-center gap-2">
                <Clipboard size={18} className="text-[#4318FF]" /> Clinical Variables
              </h4>
              <div className="space-y-3">
                {[
                    { label: 'HbA1c', value: `${patient.hba1c}%` },
                    { label: 'Fasting Blood Sugar', value: `${patient.fbs} mg/dL` },
                    { label: 'BMI', value: patient.bmi },
                    { label: 'Blood Pressure', value: patient.bp },
                    { label: 'Activity Level', value: patient.activity },
                ].map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-[#F4F7FE] rounded-xl hover:bg-[#EFF4FB] transition-colors">
                        <span className="text-[#707EAE] text-sm font-medium">{item.label}</span>
                        <span className="text-[#1B2559] font-bold">{item.value}</span>
                    </div>
                ))}
              </div>
            </div>
          </div>
          <div className="lg:col-span-2 space-y-8">
            <div className="bg-white p-8 rounded-3xl shadow-sm border border-[#E0E5F2]">
              <div className="flex justify-between items-center mb-8">
                <h3 className="text-[#1B2559] font-bold text-xl flex items-center gap-2"><TrendingUp size={20} className="text-[#4318FF]" /> Historical Biomarker Trends</h3>
                <div className="flex gap-4">
                  <span className="flex items-center gap-2 text-xs font-bold text-[#1B2559]"><div className="w-2 h-2 rounded-full bg-[#4318FF]"></div> HbA1c</span>
                  <span className="flex items-center gap-2 text-xs font-bold text-[#1B2559]"><div className="w-2 h-2 rounded-full bg-[#6AD2FF]"></div> FBS (Scaled)</span>
                </div>
              </div>
              <div className="h-80 w-full relative border-l border-b border-[#E0E5F2] pl-2 pb-2">
                 {patient.history && patient.history.length > 0 ? (
                   <div className="absolute inset-0 flex items-end justify-between px-8">
                      <div className="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-50">
                        {[1, 2, 3, 4, 5].map(i => <div key={i} className="w-full h-px bg-[#E0E5F2] border-t border-dashed"></div>)}
                      </div>
                      {patient.history.map((record, i) => (
                        <div key={i} className="relative h-full flex items-end group">
                          <div className="w-8 bg-[#4318FF] rounded-t-md mx-1 hover:opacity-80 transition-all relative z-10 cursor-pointer" style={{ height: `${(record.hba1c / 10) * 100}%` }}>
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 text-xs font-bold text-white bg-[#1B2559] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{record.hba1c}%</div>
                          </div>
                          <div className="w-8 bg-[#6AD2FF] rounded-t-md mx-1 hover:opacity-80 transition-all relative z-10 cursor-pointer" style={{ height: `${(record.fbs / 200) * 100}%` }}>
                             <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 text-xs font-bold text-white bg-[#1B2559] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{record.fbs} mg/dL</div>
                          </div>
                          <div className="absolute top-full mt-4 text-xs font-bold text-[#A3AED0] w-20 text-center -ml-4">{record.date}</div>
                        </div>
                      ))}
                   </div>
                 ) : (
                   <div className="absolute inset-0 flex items-center justify-center text-[#A3AED0]">No historical data available for comparison.</div>
                 )}
              </div>
            </div>
            
            <div className="grid grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-[#E0E5F2]">
                   <h4 className="text-[#1B2559] font-bold text-sm mb-4 flex items-center gap-2"><Heart size={16} className="text-[#EE5D50]" /> Comorbidities</h4>
                   <div className="space-y-3">
                      <div className="flex justify-between text-sm p-2 rounded-lg bg-[#F4F7FE]">
                         <span className="text-[#A3AED0]">Hypertension</span>
                         <span className={`font-bold ${patient.hypertension === 'Yes' ? 'text-[#EE5D50]' : 'text-[#05CD99]'}`}>{patient.hypertension}</span>
                      </div>
                      <div className="flex justify-between text-sm p-2 rounded-lg bg-[#F4F7FE]">
                         <span className="text-[#A3AED0]">Heart Disease</span>
                         <span className={`font-bold ${patient.heartDisease === 'Yes' ? 'text-[#EE5D50]' : 'text-[#05CD99]'}`}>{patient.heartDisease}</span>
                      </div>
                   </div>
                </div>
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-[#E0E5F2]">
                   <h4 className="text-[#1B2559] font-bold text-sm mb-4 flex items-center gap-2"><Activity size={16} className="text-[#707EAE]" /> Lifestyle</h4>
                   <div className="space-y-3">
                      <div className="flex justify-between text-sm p-2 rounded-lg bg-[#F4F7FE]">
                         <span className="text-[#A3AED0]">Smoking History</span>
                         <span className={`font-bold ${patient.smoking === 'Yes' ? 'text-[#EE5D50]' : 'text-[#05CD99]'}`}>{patient.smoking}</span>
                      </div>
                   </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  if (viewState === 'form') {
    return (
      <div className="max-w-6xl mx-auto w-full animate-fade-in pb-8">
         <header className="flex items-center gap-4 mb-8">
          <button onClick={() => setViewState('list')} className="w-12 h-12 bg-white rounded-2xl shadow-sm flex items-center justify-center text-[#1B2559] hover:bg-[#F4F7FE] transition-colors border border-[#E0E5F2]">
            <ChevronRight className="rotate-180" />
          </button>
          <div>
            <h2 className="text-3xl font-bold text-[#1B2559]">New Assessment</h2>
            <p className="text-[#A3AED0]">Complete biomarker data for Cluster-Based Identification.</p>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Main Form - Organized Layout */}
          <div className="lg:col-span-2 space-y-8">
            <div className="bg-white p-8 rounded-3xl shadow-sm border border-[#E0E5F2]">
              
              {/* Section 1: Demographics */}
              <div className="mb-8">
                <h3 className="text-[#1B2559] text-lg font-bold mb-6 flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg bg-[#4318FF]/10 text-[#4318FF] flex items-center justify-center"><Users size={18}/></div>
                    Patient Demographics
                </h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Name</label>
                        <input type="text" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" onChange={(e) => setFormData({...formData, name: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Age</label>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" onChange={(e) => setFormData({...formData, age: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Weight (kg)</label>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" onChange={(e) => setFormData({...formData, weight: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Height (cm)</label>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" onChange={(e) => setFormData({...formData, height: e.target.value})} />
                    </div>
                    <div className="space-y-2 col-span-2 md:col-span-1">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Menopausal Status</label>
                        <select className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all appearance-none" onChange={(e) => setFormData({...formData, menopauseStatus: e.target.value})}>
                            <option value="Perimenopause">Perimenopause</option>
                            <option value="Menopause">Menopause</option>
                            <option value="Postmenopause">Postmenopause</option>
                            <option value="Surgical Menopause">Surgical Menopause</option>
                        </select>
                    </div>
                    {formData.menopauseStatus !== 'Perimenopause' && (
                        <div className="space-y-2 col-span-2 md:col-span-2 animate-fade-in">
                            <label className="text-[#1B2559] text-sm font-bold ml-1">Years Since Menopause</label>
                            <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" onChange={(e) => setFormData({...formData, yearsMenopause: e.target.value})} />
                        </div>
                    )}
                </div>
              </div>

              <div className="w-full h-px bg-[#E0E5F2] my-8" />

              {/* Section 2: Blood Biomarkers */}
              <div className="mb-8">
                <h3 className="text-[#1B2559] text-lg font-bold mb-6 flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg bg-[#4318FF]/10 text-[#4318FF] flex items-center justify-center"><Thermometer size={18}/></div>
                    Blood Biomarkers
                </h3>
                <div className="grid grid-cols-2 gap-6 mb-6">
                    <div className="space-y-2">
                        <div className="flex justify-between">
                            <label className="text-[#1B2559] text-sm font-bold ml-1">Fasting Blood Sugar</label>
                            <span className="text-[#A3AED0] text-xs">Normal: &lt;100</span>
                        </div>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" placeholder="mg/dL" onChange={(e) => setFormData({...formData, fbs: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <div className="flex justify-between">
                            <label className="text-[#1B2559] text-sm font-bold ml-1">HbA1c (%)</label>
                            <span className="text-[#A3AED0] text-xs">Normal: &lt;5.7%</span>
                        </div>
                        <input type="number" step="0.1" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] focus:ring-4 focus:ring-[#4318FF]/10 outline-none transition-all" placeholder="%" onChange={(e) => setFormData({...formData, hba1c: e.target.value})} />
                    </div>
                </div>
                
                {/* Lipid Profile */}
                <div className="bg-[#F4F7FE] p-6 rounded-2xl border border-[#E0E5F2]">
                    <h4 className="text-[#707EAE] font-bold text-sm uppercase mb-4">Lipid Profile</h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="space-y-2">
                            <label className="text-[#1B2559] text-xs font-bold ml-1">Total Cholesterol</label>
                            <input type="number" className="w-full bg-white border border-transparent p-3 rounded-lg text-[#1B2559] focus:border-[#4318FF] outline-none transition-all shadow-sm" placeholder="mg/dL" onChange={(e) => setFormData({...formData, cholesterol: e.target.value})} />
                        </div>
                        <div className="space-y-2">
                            <label className="text-[#1B2559] text-xs font-bold ml-1">Triglycerides</label>
                            <input type="number" className="w-full bg-white border border-transparent p-3 rounded-lg text-[#1B2559] focus:border-[#4318FF] outline-none transition-all shadow-sm" placeholder="mg/dL" onChange={(e) => setFormData({...formData, triglycerides: e.target.value})} />
                        </div>
                        <div className="space-y-2">
                            <label className="text-[#1B2559] text-xs font-bold ml-1">LDL-C</label>
                            <input type="number" className="w-full bg-white border border-transparent p-3 rounded-lg text-[#1B2559] focus:border-[#4318FF] outline-none transition-all shadow-sm" placeholder="mg/dL" onChange={(e) => setFormData({...formData, ldl: e.target.value})} />
                        </div>
                        <div className="space-y-2">
                            <label className="text-[#1B2559] text-xs font-bold ml-1">HDL-C</label>
                            <input type="number" className="w-full bg-white border border-transparent p-3 rounded-lg text-[#1B2559] focus:border-[#4318FF] outline-none transition-all shadow-sm" placeholder="mg/dL" onChange={(e) => setFormData({...formData, hdl: e.target.value})} />
                        </div>
                    </div>
                </div>
              </div>

              <div className="w-full h-px bg-[#E0E5F2] my-8" />

              {/* Section 3: History & Lifestyle */}
              <div>
                 <h3 className="text-[#1B2559] text-lg font-bold mb-6 flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg bg-[#4318FF]/10 text-[#4318FF] flex items-center justify-center"><Clipboard size={18}/></div>
                    Medical History & Lifestyle
                </h3>
                <div className="grid grid-cols-2 gap-6 mb-6">
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Systolic BP</label>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] outline-none transition-all" placeholder="mmHg" onChange={(e) => setFormData({...formData, systolic: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Diastolic BP</label>
                        <input type="number" className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] outline-none transition-all" placeholder="mmHg" onChange={(e) => setFormData({...formData, diastolic: e.target.value})} />
                    </div>
                    <div className="space-y-2 col-span-2">
                        <label className="text-[#1B2559] text-sm font-bold ml-1">Physical Activity</label>
                        <select className="w-full bg-[#F4F7FE] border border-transparent p-4 rounded-xl text-[#1B2559] focus:bg-white focus:border-[#4318FF] outline-none transition-all appearance-none" onChange={(e) => setFormData({...formData, activity: e.target.value})}>
                            <option value="Sedentary">Sedentary</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Active">Active</option>
                        </select>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                   <label className="flex items-center gap-3 p-4 rounded-xl border border-[#E0E5F2] cursor-pointer hover:bg-[#F4F7FE] transition-colors">
                      <input type="checkbox" className="w-5 h-5 rounded text-[#4318FF] focus:ring-[#4318FF]" onChange={(e) => setFormData({...formData, history: e.target.checked})}/>
                      <span className="text-[#1B2559] font-medium">Family History of Diabetes</span>
                   </label>
                   <label className="flex items-center gap-3 p-4 rounded-xl border border-[#E0E5F2] cursor-pointer hover:bg-[#F4F7FE] transition-colors">
                      <input type="checkbox" className="w-5 h-5 rounded text-[#4318FF] focus:ring-[#4318FF]" onChange={(e) => setFormData({...formData, smoking: e.target.checked ? 'Yes' : 'No'})}/>
                      <span className="text-[#1B2559] font-medium">Smoking History</span>
                   </label>
                   <label className="flex items-center gap-3 p-4 rounded-xl border border-[#E0E5F2] cursor-pointer hover:bg-[#F4F7FE] transition-colors">
                      <input type="checkbox" className="w-5 h-5 rounded text-[#4318FF] focus:ring-[#4318FF]" onChange={(e) => setFormData({...formData, hypertension: e.target.checked ? 'Yes' : 'No'})}/>
                      <span className="text-[#1B2559] font-medium">History of Hypertension</span>
                   </label>
                   <label className="flex items-center gap-3 p-4 rounded-xl border border-[#E0E5F2] cursor-pointer hover:bg-[#F4F7FE] transition-colors">
                      <input type="checkbox" className="w-5 h-5 rounded text-[#4318FF] focus:ring-[#4318FF]" onChange={(e) => setFormData({...formData, heartDisease: e.target.checked ? 'Yes' : 'No'})}/>
                      <span className="text-[#1B2559] font-medium">History of Heart Disease</span>
                   </label>
                </div>
              </div>
            </div>
          </div>

          {/* Results Panel */}
          <div className="lg:col-span-1 space-y-6">
             <div className="bg-[#111C44] rounded-3xl p-8 text-white relative overflow-hidden shadow-xl">
                <div className="relative z-10">
                   <h3 className="text-2xl font-bold mb-2">Live Analysis</h3>
                   <p className="opacity-70 text-sm mb-6">Real-time BMI calculation based on input parameters.</p>
                   
                   <div className="flex justify-between items-end border-b border-white/20 pb-4 mb-4">
                      <span className="text-sm opacity-80">Calculated BMI</span>
                      <span className="text-3xl font-bold">{calculatedBMI || '--.-'}</span>
                   </div>
                   
                   <div className="text-xs opacity-60">
                      Fill in all core biomarkers to enable risk prediction and cluster assignment.
                   </div>
                </div>
                <Activity size={120} className="absolute -bottom-6 -right-6 opacity-10" />
             </div>

                   <div className="bg-white rounded-3xl shadow-sm p-6 border border-[#E0E5F2] sticky top-6">
                <h3 className="text-[#1B2559] font-bold text-xl mb-6">Action</h3>
                <div className="space-y-4">
                   <Button fullWidth onClick={calculateRisk} disabled={isComputing}>
                      {isComputing ? 'Processing...' : 'Run Cluster Analysis'}
                   </Button>
                   <Button variant="ghost" fullWidth onClick={() => setViewState('list')}>Cancel Assessment</Button>
                </div>
                
                {prediction !== null && (
                   <div className="mt-8 pt-8 border-t border-[#E0E5F2] animate-fade-in">
                      <div className="text-center">
                         <p className="text-[#A3AED0] text-xs font-bold uppercase tracking-widest mb-1">Identified Cluster</p>
                         <h2 className="text-4xl font-bold text-[#4318FF] mb-2">{cluster}</h2>
                         <div className={`inline-block px-3 py-1 rounded-full text-xs font-bold mb-4 ${prediction > 66 ? 'bg-[#EE5D50] text-white' : 'bg-[#6AD2FF] text-white'}`}>
                            {prediction}% Risk Probability
                         </div>
                         <Button variant="outline" fullWidth icon={Save}>Save to Registry</Button>
                      </div>
                   </div>
                )}
             </div>
          </div>
        </div>
      </div>
    );
  }

  // Default List View
  return (
    <div className="h-full flex flex-col animate-fade-in pb-8">
      <header className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8">
        <div>
          <h4 className="text-[#707EAE] font-medium text-sm mb-1">Database</h4>
          <h2 className="text-3xl font-bold text-[#1B2559]">Patient History</h2>
        </div>
        <div className="mt-4 md:mt-0 flex gap-3">
          <div className="relative group">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[#A3AED0] group-hover:text-[#4318FF] transition-colors" size={18} />
            <input 
              type="text" 
              placeholder="Search records..." 
              className="pl-10 pr-4 py-3 rounded-xl bg-white text-[#1B2559] placeholder-[#A3AED0] focus:outline-none focus:ring-2 focus:ring-[#4318FF] w-64 shadow-sm border border-[#E0E5F2]"
            />
          </div>
        </div>
      </header>

      <div className="bg-white rounded-3xl shadow-sm overflow-hidden border border-[#E0E5F2]">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-[#E0E5F2] bg-[#F4F7FE]">
                <th className="p-6 text-[#A3AED0] font-medium text-sm uppercase tracking-wider">Patient</th>
                <th className="p-6 text-[#A3AED0] font-medium text-sm uppercase tracking-wider">Status</th>
                <th className="p-6 text-[#A3AED0] font-medium text-sm uppercase tracking-wider">Biomarkers</th>
                <th className="p-6 text-[#A3AED0] font-medium text-sm uppercase tracking-wider">Assigned Cluster</th>
                <th className="p-6 text-[#A3AED0] font-medium text-sm uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#E0E5F2]">
              {(patientsProp.length ? patientsProp : MOCK_PATIENTS).map((p) => (
                <tr key={p.id} className="hover:bg-[#F4F7FE] transition-colors group cursor-pointer" onClick={() => handleViewProfile(p)}>
                  <td className="p-6">
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-full bg-[#4318FF] text-white flex items-center justify-center font-bold shadow-md group-hover:scale-110 transition-transform">
                        {p.name.charAt(0)}
                      </div>
                      <div>
                        <div className="text-[#1B2559] font-bold text-sm group-hover:text-[#4318FF] transition-colors">{p.name}</div>
                        <div className="text-[#A3AED0] text-xs font-medium">ID: {p.idNumber}</div>
                      </div>
                    </div>
                  </td>
                  <td className="p-6">
                    <span className="text-[#1B2559] font-medium text-sm">{p.status}</span>
                    <div className="text-[#A3AED0] text-xs">Age: {p.age}</div>
                  </td>
                  <td className="p-6">
                    <div className="flex gap-2">
                      <div className="bg-[#EFF4FB] px-2 py-1 rounded text-xs font-bold text-[#1B2559] border border-[#E0E5F2]">
                        FBS: {p.fbs}
                      </div>
                      <div className="bg-[#EFF4FB] px-2 py-1 rounded text-xs font-bold text-[#1B2559] border border-[#E0E5F2]">
                        A1c: {p.hba1c}%
                      </div>
                    </div>
                  </td>
                  <td className="p-6">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                      p.cluster === 'SOIRD' || p.cluster === 'SIDD' 
                        ? 'bg-[#111C44] text-white' 
                        : 'bg-[#6AD2FF]/20 text-[#1B2559]'
                    }`}>
                      {p.cluster || 'N/A'}
                    </span>
                  </td>
                  <td className="p-6">
                    <button 
                      className="w-8 h-8 rounded-full border border-[#E0E5F2] flex items-center justify-center text-[#A3AED0] hover:text-[#4318FF] hover:border-[#4318FF] transition-colors bg-white"
                    >
                      <ChevronRight size={16} />
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// Analytics/Visualizations (Revised per Paper - Page 62, 66)
const Analytics = () => {
  const [viewMode, setViewMode] = useState('cluster'); // 'cluster' or 'correlation'

  return (
    <div className="space-y-8 animate-fade-in pb-8">
       <header className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8">
          <div>
            <h4 className="text-[#707EAE] font-medium text-sm mb-1">Insights & Clustering</h4>
            <h2 className="text-3xl font-bold text-[#1B2559]">Analytics</h2>
          </div>
          <div className="mt-4 md:mt-0 flex gap-2">
            <Button variant={viewMode === 'cluster' ? 'primary' : 'outline'} onClick={() => setViewMode('cluster')} icon={PieChart}>Cluster Map</Button>
            <Button variant={viewMode === 'correlation' ? 'primary' : 'outline'} onClick={() => setViewMode('correlation')} icon={TrendingUp}>BMI vs Glucose</Button>
          </div>
       </header>

       <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2 space-y-8">
             {/* Chart Container */}
             <div className="bg-white p-8 rounded-3xl shadow-sm relative overflow-hidden border border-[#E0E5F2]">
                <div className="flex justify-between items-center mb-6">
                   <div>
                     <h3 className="text-[#1B2559] font-bold text-lg">
                        {viewMode === 'cluster' ? 'Cluster-Based Identification (k-means)' : 'BMI vs Glucose Correlation'}
                     </h3>
                     <p className="text-[#A3AED0] text-sm">
                        {viewMode === 'cluster' 
                          ? 'Visualizing patient distribution across metabolic profiles based on HbA1c and BMI.' 
                          : 'Correlation analysis of Body Mass Index against Fasting Glucose levels (Page 17).'}
                     </p>
                   </div>
                </div>
                
                <div className="h-[500px] relative border border-[#E0E5F2] rounded-2xl bg-[#F4F7FE] m-2 overflow-hidden shadow-inner">
                  {/* Shared Grid Lines */}
                  <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 pointer-events-none">
                     {[...Array(4)].map((_, i) => <div key={`v-${i}`} className="border-r border-[#E0E5F2]/50 h-full"></div>)}
                     {[...Array(4)].map((_, i) => <div key={`h-${i}`} className="border-b border-[#E0E5F2]/50 w-full col-span-4"></div>)}
                  </div>

                  {/* Axes Labels based on View Mode */}
                  <div className="absolute -left-8 top-1/2 -rotate-90 text-xs font-bold text-[#1B2559] tracking-widest">
                    {viewMode === 'cluster' ? 'BMI Index (kg/m²)' : 'Glucose Level (mg/dL)'}
                  </div>
                  <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-bold text-[#1B2559] tracking-widest">
                    {viewMode === 'cluster' ? 'HbA1c Level (%)' : 'Body Mass Index (kg/m²)'}
                  </div>

                  {/* View: Cluster Map */}
                  {viewMode === 'cluster' && (
                    <>
                      {/* Cluster Zones */}
                      <div className="absolute top-4 right-4 w-[40%] h-[40%] bg-gradient-to-bl from-[#FFB547]/20 to-transparent rounded-tr-xl border-t border-r border-[#FFB547]/30 flex items-start justify-end p-4">
                         <span className="text-[#FFB547] font-bold text-sm tracking-wide">SOIRD Zone</span>
                      </div>
                      <div className="absolute bottom-4 right-4 w-[40%] h-[40%] bg-gradient-to-tl from-[#EE5D50]/20 to-transparent rounded-br-xl border-b border-r border-[#EE5D50]/30 flex items-end justify-end p-4">
                         <span className="text-[#EE5D50] font-bold text-sm tracking-wide">SIDD Zone</span>
                      </div>
                      <div className="absolute top-1/3 left-4 w-[40%] h-[33%] bg-gradient-to-r from-[#6AD2FF]/20 to-transparent rounded-l-xl border-l border-[#6AD2FF]/30 flex items-center justify-start p-4">
                         <span className="text-[#6AD2FF] font-bold text-sm tracking-wide">MARD Zone</span>
                      </div>
                      <div className="absolute bottom-4 left-4 w-[35%] h-[35%] bg-gradient-to-tr from-[#4318FF]/20 to-transparent rounded-bl-xl border-b border-l border-[#4318FF]/30 flex items-end justify-start p-4">
                         <span className="text-[#4318FF] font-bold text-sm tracking-wide">MIDD Zone</span>
                      </div>

                      {/* Scatter Points (HbA1c vs BMI) */}
                      {MOCK_PATIENTS.map((p, i) => {
                        const left = Math.min(Math.max(((p.hba1c - 4) / 8) * 100, 5), 95);
                        const bottom = Math.min(Math.max(((p.bmi - 18) / 22) * 100, 5), 95);
                        let color = '#4318FF'; 
                        if (p.cluster === 'SOIRD') color = '#FFB547';
                        if (p.cluster === 'SIDD') color = '#EE5D50';
                        if (p.cluster === 'MARD') color = '#6AD2FF';

                        return (
                          <div key={i} className="absolute w-4 h-4 rounded-full border-2 border-white shadow-lg hover:scale-150 transition-all cursor-pointer flex items-center justify-center group" style={{ left: `${left}%`, bottom: `${bottom}%`, backgroundColor: color }}>
                            <div className="absolute bottom-full mb-3 bg-[#1B2559] text-white text-[11px] p-3 rounded-xl whitespace-nowrap hidden group-hover:block shadow-xl z-50">
                              <div className="font-bold text-sm mb-1">{p.name}</div>
                              <div className="opacity-80">BMI: {p.bmi} • HbA1c: {p.hba1c}%</div>
                            </div>
                          </div>
                        );
                      })}
                    </>
                  )}

                  {/* View: Correlation Map (BMI vs Glucose) */}
                  {viewMode === 'correlation' && (
                    <>
                       {/* Regression Line Simulation */}
                       <div className="absolute bottom-[20%] left-[20%] w-[60%] h-[2px] bg-[#EE5D50]/50 rotate-[-35deg] transform origin-bottom-left"></div>
                       
                       {/* Scatter Points (BMI vs FBS) */}
                       {MOCK_PATIENTS.map((p, i) => {
                        // X axis = BMI (18-40), Y axis = Glucose (70-200)
                        const left = Math.min(Math.max(((p.bmi - 18) / 22) * 100, 5), 95);
                        const bottom = Math.min(Math.max(((p.fbs - 70) / 130) * 100, 5), 95);

                        return (
                          <div key={i} className="absolute w-3 h-3 rounded-full bg-[#4318FF] opacity-70 hover:opacity-100 hover:scale-150 transition-all cursor-pointer" style={{ left: `${left}%`, bottom: `${bottom}%` }}></div>
                        );
                      })}
                    </>
                  )}
                </div>
             </div>
          </div>

          <div className="space-y-8">
             {/* Model Performance Card (Phase 2b Validation) */}
             <div className="bg-white p-8 rounded-3xl shadow-sm border border-[#E0E5F2]">
                <h3 className="text-[#1B2559] font-bold text-lg mb-6">Model Performance (Phase 2b)</h3>
                <div className="space-y-4">
                   <div className="flex justify-between items-center p-3 bg-[#F4F7FE] rounded-xl">
                      <span className="text-[#707EAE] text-sm font-medium">AUC-ROC</span>
                      <span className="text-[#1B2559] font-bold">0.92</span>
                   </div>
                   <div className="flex justify-between items-center p-3 bg-[#F4F7FE] rounded-xl">
                      <span className="text-[#707EAE] text-sm font-medium">F1-Score</span>
                      <span className="text-[#1B2559] font-bold">0.89</span>
                   </div>
                   <div className="flex justify-between items-center p-3 bg-[#F4F7FE] rounded-xl">
                      <span className="text-[#707EAE] text-sm font-medium">Accuracy</span>
                      <span className="text-[#1B2559] font-bold">94.1%</span>
                   </div>
                   <div className="text-xs text-[#A3AED0] mt-2 pt-2 border-t border-[#E0E5F2]">
                      Evaluated on 30% held-out test set using Random Forest algorithm.
                   </div>
                </div>
             </div>

             <div className="bg-white p-8 rounded-3xl shadow-sm border border-[#E0E5F2]">
                <h3 className="text-[#1B2559] font-bold text-lg mb-6">Feature Importance (IG)</h3>
                <div className="space-y-6">
                  {[
                    { label: 'Body Mass Index', val: 92, color: '#4318FF' }, 
                    { label: 'HbA1c Level', val: 88, color: '#6AD2FF' }, 
                    { label: 'Patient Age', val: 75, color: '#05CD99' }, 
                    { label: 'Blood Pressure', val: 65, color: '#FFB547' }
                  ].map((item, i) => (
                    <div key={i} className="group">
                       <div className="flex justify-between text-sm font-bold text-[#1B2559] mb-2">
                         <span>{item.label}</span>
                         <span className="text-[#A3AED0]">{item.val/100} IG</span>
                       </div>
                       <div className="w-full h-3 bg-[#F4F7FE] rounded-full relative overflow-hidden">
                         <div className="h-full rounded-full" style={{ width: `${item.val}%`, backgroundColor: item.color }} />
                       </div>
                    </div>
                  ))}
                </div>
             </div>
          </div>
       </div>
    </div>
  );
};

const App = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [authToken, setAuthToken] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [patientViewState, setPatientViewState] = useState('list'); // list | form | profile
  const [patients, setPatients] = useState([]);
  const [patientsLoading, setPatientsLoading] = useState(false);
  const [patientsError, setPatientsError] = useState(null);
  const [assessmentsCache, setAssessmentsCache] = useState({});

  const handleLogin = async (email, password) => {
    const res = await loginApi(email, password);
    if (res && res.token) {
      setAuthToken(res.token);
      setIsAuthenticated(true);
    } else {
      throw new Error('login failed');
    }
  };

  useEffect(() => {
    if (!authToken) return;
    const loadPatients = async () => {
      setPatientsLoading(true);
      setPatientsError(null);
      try {
        const data = await fetchPatientsApi(authToken);
        setPatients(data || []);
      } catch (err) {
        setPatientsError('Failed to load patients.');
      } finally {
        setPatientsLoading(false);
      }
    };
    loadPatients();
  }, [authToken]);

  const loadAssessments = async (patientId) => {
    if (assessmentsCache[patientId]) return assessmentsCache[patientId];
    const data = await fetchAssessmentsApi(authToken, patientId);
    setAssessmentsCache((prev) => ({ ...prev, [patientId]: data || [] }));
    return data || [];
  };

  const handleAssessmentSubmit = async (formData, bmi) => {
    if (!authToken) throw new Error('not authenticated');
    // Create patient first
    const patientPayload = {
      name: formData.name || 'New Patient',
      age: parseInt(formData.age) || null,
      menopause_status: formData.menopauseStatus,
      years_menopause: parseInt(formData.yearsMenopause) || null,
      bmi: bmi || null,
      bp_systolic: parseInt(formData.systolic) || null,
      bp_diastolic: parseInt(formData.diastolic) || null,
      activity: formData.activity,
      smoking: formData.smoking,
      hypertension: formData.hypertension,
      heart_disease: formData.heartDisease,
      chol: parseInt(formData.cholesterol) || null,
      ldl: parseInt(formData.ldl) || null,
      hdl: parseInt(formData.hdl) || null,
      triglycerides: parseInt(formData.triglycerides) || null,
    };
    const patient = await createPatientApi(authToken, patientPayload);
    // Create assessment
    const assessmentPayload = {
      fbs: parseFloat(formData.fbs) || 0,
      hba1c: parseFloat(formData.hba1c) || 0,
      cholesterol: parseInt(formData.cholesterol) || null,
      ldl: parseInt(formData.ldl) || null,
      hdl: parseInt(formData.hdl) || null,
      triglycerides: parseInt(formData.triglycerides) || null,
      systolic: parseInt(formData.systolic) || null,
      diastolic: parseInt(formData.diastolic) || null,
      activity: formData.activity,
      history_flag: !!formData.history,
      smoking: formData.smoking,
      hypertension: formData.hypertension,
      heart_disease: formData.heartDisease,
      bmi: bmi || null,
    };
    const assessment = await createAssessmentApi(authToken, patient.id, assessmentPayload);
    // refresh patient list cache
    setPatients((prev) => [patient, ...prev]);
    setAssessmentsCache((prev) => ({ ...prev, [patient.id]: [assessment] }));
    return {
      cluster: assessment.cluster,
      risk_score: assessment.risk_score ?? assessment.riskScore,
      validation_status: assessment.validation_status ?? assessment.validationStatus,
    };
  };

  const handleStartAssessment = () => {
    setActiveTab('patients');
    setPatientViewState('form');
  };

  const renderContent = () => {
    switch (activeTab) {
      case 'dashboard':
        return <Dashboard onNavigateToPatient={() => setActiveTab('patients')} onStartAssessment={handleStartAssessment} />;
      case 'patients':
        return (
          <>
            {patientsError && <div className="text-red-600 mb-2">{patientsError}</div>}
            <PatientHistory
              viewState={patientViewState}
              setViewState={setPatientViewState}
              patients={patients}
              loadAssessments={loadAssessments}
              onSubmitAssessment={handleAssessmentSubmit}
            />
          </>
        );
      case 'analytics':
        return <Analytics />;
      case 'export':
        return (
          <div className="bg-white p-8 rounded-3xl shadow-sm border border-[#E0E5F2]">
            <h2 className="text-2xl font-bold text-[#1B2559] mb-4">Export Data</h2>
            <p className="text-[#A3AED0] mb-4">Use backend export endpoints to download CSVs for patients and assessments.</p>
            <div className="space-y-3">
              <a className="text-[#4318FF] font-bold hover:underline" href={`${API_BASE}/api/v1/export/patients.csv`} target="_blank" rel="noreferrer">Download Patients CSV</a>
              <a className="text-[#4318FF] font-bold hover:underline" href={`${API_BASE}/api/v1/export/assessments.csv`} target="_blank" rel="noreferrer">Download Assessments CSV</a>
            </div>
          </div>
        );
      default:
        return <Dashboard onNavigateToPatient={() => setActiveTab('patients')} onStartAssessment={handleStartAssessment} />;
    }
  };

  if (!isAuthenticated) {
    return <Login onLogin={handleLogin} />;
  }

  return (
    <div className="flex bg-[#F4F7FE]">
      <Sidebar
        activeTab={activeTab}
        setActiveTab={setActiveTab}
        onStartAssessment={handleStartAssessment}
      />
      <main className="flex-1 ml-20 lg:ml-72 p-6 lg:p-10">
        {renderContent()}
      </main>
    </div>
  );
};

export default App;